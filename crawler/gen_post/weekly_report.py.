'''
ì „ì²´ ìœ„í´ë¦¬ ë ˆí¬íŠ¸ ìƒì„± ë° supabase post ì „ì²´ ì½”ë“œì…ë‹ˆë‹¤.
ì‹¤í–‰ ì‹œ, ê¸°ì—…ë³„ ìœ„í´ë¦¬ ë ˆí¬íŠ¸ ë° ì „ì²´ ìœ„í´ë¦¬ ë ˆí¬íŠ¸ ëª¨ë‘ í•œë²ˆì— ìƒì„± í›„ ì „ì²´ ìœ„í´ë¦¬ ë ˆí¬íŠ¸ post í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
'''

import requests
import json
from datetime import datetime, timedelta
from openai import OpenAI
from api.gen_post.gen_comp_weekly import generate_weekly_reports
from api.get.get_market_condition import get_market_condition as fetch_market_condition
from api.get.get_news import get_news as fetch_news

API_URL = "http://localhost:3000/api/weekly-report"
def cal_cost(prompt_tokens, completion_tokens):
    input_price = 2.50 / 1_000_000
    output_price = 10.00 / 1_000_000
    return prompt_tokens * input_price + completion_tokens * output_price

def get_market_condition(start_date, end_date):
    market_data = []
    current_date = start_date
    while current_date <= end_date:
        data = fetch_market_condition(current_date)
        if data:
            market_data.extend(data)
        else:
            print(f"âŒ {current_date} ì‹œì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨")
        current_date += timedelta(days=1)
    return market_data

def get_news(start_date, end_date):
    news_data = []
    current_date = start_date
    while current_date <= end_date:
        data = fetch_news(current_date)
        if data:
            news_data.extend(data)
        else:
            print(f"âŒ {current_date} ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨")
        current_date += timedelta(days=1)
    return news_data

def get_full_context(start_date, end_date, market_data, news_data):
    full_context = ""

    if market_data:
        full_context += "ğŸ“Œ ì‹œì¥ ë°ì´í„° ìš”ì•½:\n"
        for entry in market_data:
            full_context += f"- {entry.get('content', 'ë‚´ìš© ì—†ìŒ')}\n"

    if news_data:
        full_context += "\nğŸ“Œ ë‰´ìŠ¤ ìš”ì•½:\n"
        for entry in news_data:
            full_context += f"- {entry.get('content', 'ë‚´ìš© ì—†ìŒ')}\n"

    return full_context.strip()

def prompting(start_date, end_date, full_content):
    return f"""
    ğŸ’¡ ì—­í• : ë‹¹ì‹ ì€ ê¸ˆìœµ ì‹œì¥ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°ê´€ì ì´ê³  ëª…í™•í•œ ë°©ì‹ìœ¼ë¡œ ì£¼ê°„ ì¦ì‹œ ìš”ì•½ì„ ì‘ì„±í•˜ì„¸ìš”.

    ğŸ“Œ **ì£¼ê°„ ì¦ì‹œ ìš”ì•½**
    ë‹¤ìŒì˜ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ "Fingoo ì£¼ê°„ ì¦ì‹œ ìš”ì•½"ì„ ì‘ì„±í•˜ì„¸ìš”. ì œê³µëœ ë°ì´í„°ëŠ” {start_date} ~ {end_date} ê¸°ê°„ ë™ì•ˆì˜ ë¯¸êµ­ ì¦ì‹œ ê´€ë ¨ ë‰´ìŠ¤ ë° ë¶„ì„ ìë£Œì…ë‹ˆë‹¤.

    ğŸ“Œ **ë³´ê³ ì„œ ê¸°ê°„**: {start_date} ~ {end_date}

    ...

    âš  **ë°˜ë“œì‹œ ì£¼ì–´ì§„ ë°ì´í„°ë§Œì„ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”. ì¶”ê°€ì ì¸ ê°€ì •ì´ë‚˜ ì°½ì‘ì€ í•˜ì§€ ë§ˆì„¸ìš”.**  
    âš  **ì •ë³´ì˜ ì •í™•ì„±ì„ ìœ ì§€í•˜ë©°, ì§€ë‚˜ì¹˜ê²Œ ê·¹ì ì¸ í‘œí˜„ì€ í”¼í•˜ì„¸ìš”.**  
    âš  **ì •ë³´ì˜ ì¶œì²˜ë¥¼ ì ˆëŒ€ ê¸°ì…í•˜ì§€ ë§ˆì„¸ìš”.**  

    " âš  ë³¸ Fingoo ì£¼ê°„ ì¦ì‹œ ë ˆí¬íŠ¸ëŠ” ê³µì‹ ë ¥ ìˆëŠ” ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ Fingoo AI ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."ë¥¼ ë§ˆì§€ë§‰ì— ì¶œë ¥í•´ ì£¼ì„¸ìš”.

    ìœ„ í¬ë©§ì— ë§ì¶°ì„œ {start_date} ~ {end_date} ê¸°ê°„ì˜ ì•„ë˜ `context` ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì—¬ ì£¼ê°„ ì‹œí™©ì„ ì‘ì„±í•˜ì„¸ìš”.
    context: {full_content}
    """

def generate_weekly_report(start_date, end_date):
    # 1. ì‹œí™© ë° ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘
    market_data = get_market_condition(start_date, end_date)
    news_data = get_news(start_date, end_date)

    # 2. ì „ì²´ context êµ¬ì„±
    full_context = get_full_context(start_date, end_date, market_data, news_data)

    # 3. ê¸°ì—…ë³„ ë¦¬í¬íŠ¸ ì¶”ê°€
    company_reports = generate_weekly_reports(start_date, end_date)
    if company_reports:
        full_context += "\n\nğŸ“Œ ê¸°ì—…ë³„ ì£¼ê°„ ë¦¬í¬íŠ¸:\n"
        for company, report in company_reports.items():
            full_context += f"\nğŸ”¹ {company} ì£¼ê°„ ë¦¬í¬íŠ¸:\n{report.strip()}\n"

    # 4. GPT í”„ë¡¬í”„íŠ¸ ìƒì„± ë° í˜¸ì¶œ
    prompt = prompting(start_date, end_date, full_context)
    client = OpenAI(api_key="YOUR_OPENAI_API_KEY")
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "ë‹¹ì‹ ì€ ì£¼ì‹ ì „ë¬¸ê°€ì…ë‹ˆë‹¤."},
            {"role": "user", "content": prompt}
        ]
    )

    content = response.choices[0].message.content
    cost = cal_cost(response.usage.prompt_tokens, response.usage.completion_tokens)
    print(f"ğŸ’¸ ìœ„í´ë¦¬ ë¦¬í¬íŠ¸ ìƒì„± ì½”ìŠ¤íŠ¸: ${cost:.6f}")

    # 5. ì„œë²„ì— POST
    item = {
        "start_date": str(start_date),
        "end_date": str(end_date),
        "content": content,
        "market_analysis_ids": [entry["id"] for entry in market_data if "id" in entry],
        "news_ids": [entry["id"] for entry in news_data if "id" in entry],
    }

    res = requests.post(API_URL, json=item)
    print(f"ğŸ“¡ POST ê²°ê³¼: {res.status_code}, {res.text}")

    return content

if __name__ == "__main__":
    # â±ï¸ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ ì£¼ê°„ ë¦¬í¬íŠ¸ ë‚ ì§œ ë²”ìœ„
    end_date = datetime.strptime("2025-04-06", "%Y-%m-%d").date()
    start_date = end_date - timedelta(days=6)

    print(f"ğŸ“… {start_date} ~ {end_date} ìœ„í´ë¦¬ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...")
    generate_weekly_report(start_date, end_date)
